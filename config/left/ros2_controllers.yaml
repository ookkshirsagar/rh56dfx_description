############################################################
# ROS2 CONTROL CONFIGURATION
# Robot: Inspire Hand RH56DFX Left
#
# ARCHITECTURE ROLE
# ----------------------------------------------------------
# This file defines the runtime controller graph used by
# ros2_control. It is the single source of truth for:
#
#   • Controller manager behavior
#   • Controller registration
#   • Execution parameters
#   • PID tuning values
#
# It does NOT define robot structure.
# It does NOT define kinematics.
# It ONLY defines control layer logic.
#
# Compatible with:
#   • FakeSystem simulation backend
#   • Real hardware drivers
#   • MoveIt execution pipelines
#
############################################################



############################################################
# CONTROLLER MANAGER CORE
############################################################
controller_manager:
  ros__parameters:

    ########################################################
    # CONTROL LOOP RATE
    # ------------------------------------------------------
    # Frequency at which controllers update.
    #
    # 100 Hz is stable for position controlled hands.
    # Lower values → sluggish response
    # Higher values → higher CPU load
    ########################################################
    update_rate: 100


    ########################################################
    # SIMULATION CLOCK SWITCH
    # ------------------------------------------------------
    # TRUE  → if running Gazebo or simulated clock
    # FALSE → real hardware or system clock
    ########################################################
    use_sim_time: false



    ########################################################
    # REGISTERED CONTROLLERS
    # ------------------------------------------------------
    # This section ONLY registers controllers.
    # Parameters are defined later.
    #
    # Missing entry here → controller cannot load.
    ########################################################

    joint_state_broadcaster:
      type: joint_state_broadcaster/JointStateBroadcaster

    hand_controller:
      type: joint_trajectory_controller/JointTrajectoryController




############################################################
# JOINT STATE BROADCASTER
############################################################
joint_state_broadcaster:
  ros__parameters:

    ########################################################
    # STATE STREAM RATE
    # ------------------------------------------------------
    # Frequency of /joint_states publication.
    #
    # 50 Hz gives smooth visualization while keeping
    # CPU usage reasonable.
    ########################################################
    state_publish_rate: 50




############################################################
# TRAJECTORY CONTROLLER CONFIGURATION
############################################################
hand_controller:
  ros__parameters:



    ########################################################
    # CONTROLLED JOINT LIST
    # ------------------------------------------------------
    # ONLY independently actuated joints belong here.
    #
    # DO NOT list:
    #   • mimic joints
    #   • fixed joints
    #
    # Mimic joints move automatically via URDF mimic tags.
    #
    # Order is CRITICAL.
    # Trajectory vectors map index-wise.
    ########################################################
    joints:

      ######################################################
      # WRIST DOF
      ######################################################
      - l_wrist_yaw_joint
      - l_hand_base_joint


      ######################################################
      # THUMB ACTUATORS
      # (distal joints are mimic and excluded)
      ######################################################
      - left_thumb_1_joint
      - left_thumb_2_joint


      ######################################################
      # FINGER PRIMARY JOINTS
      ######################################################
      - left_index_1_joint
      - left_middle_1_joint
      - left_ring_1_joint
      - left_little_1_joint



    ########################################################
    # COMMAND INTERFACE TYPE
    # ------------------------------------------------------
    # Defines signal sent to hardware.
    #
    # position → most stable and recommended
    # velocity → used for velocity driven systems
    # effort   → torque control systems
    ########################################################
    command_interfaces:
      - position



    ########################################################
    # STATE FEEDBACK INTERFACES
    # ------------------------------------------------------
    # Must match hardware interface capabilities.
    #
    # Required for:
    #   trajectory validation
    #   MoveIt execution monitoring
    #   RViz visualization
    ########################################################
    state_interfaces:
      - position
      - velocity



    ########################################################
    # TRAJECTORY EXECUTION SETTINGS
    ########################################################

    # Smooth spline interpolation reduces mechanical stress
    interpolation_method: splines

    # Allow completion even if velocity ≠ 0 at goal
    allow_nonzero_velocity_at_trajectory_end: true



    ########################################################
    # MONITORING RATES
    ########################################################
    state_publish_rate: 50
    action_monitor_rate: 20



    ########################################################
    # EXECUTION SAFETY CONSTRAINTS
    ########################################################
    constraints:

      # Allowed timing deviation for reaching goal
      goal_time: 0.5

      # Velocity threshold considered "stopped"
      stopped_velocity_tolerance: 0.05



    ########################################################
    # PID GAINS
    # ------------------------------------------------------
    # REQUIRED for real hardware controllers.
    # Ignored in FakeSystem simulation.
    #
    # Values below are conservative starting gains.
    # Always tune experimentally for real hardware.
    ########################################################
    gains:

      ######################################################
      # WRIST JOINTS
      ######################################################
      l_wrist_yaw_joint: {p: 50.0, i: 0.0, d: 2.0}
      l_hand_base_joint: {p: 50.0, i: 0.0, d: 2.0}


      ######################################################
      # THUMB
      ######################################################
      left_thumb_1_joint: {p: 30.0, i: 0.0, d: 1.0}
      left_thumb_2_joint: {p: 30.0, i: 0.0, d: 1.0}


      ######################################################
      # FINGERS
      ######################################################
      left_index_1_joint:  {p: 30.0, i: 0.0, d: 1.0}
      left_middle_1_joint: {p: 30.0, i: 0.0, d: 1.0}
      left_ring_1_joint:   {p: 30.0, i: 0.0, d: 1.0}
      left_little_1_joint: {p: 30.0, i: 0.0, d: 1.0}



############################################################
# SYSTEM VALIDATION CHECKLIST
############################################################
#
# After launch verify controllers:
#
#   ros2 control list_controllers
#
# Expected:
#   joint_state_broadcaster → active
#   hand_controller         → active
#
#
# Verify state feedback:
#   ros2 topic echo /joint_states
#
#
# Confirm trajectory action exists:
#   ros2 action list | grep follow_joint
#
############################################################



############################################################
# FAILURE DIAGNOSTICS
############################################################
#
# Controller stuck inactive
#   → joint mismatch or missing interface
#
# Activation failure
#   → gains missing or interface mismatch
#
# Robot does not move
#   → controller name mismatch in MoveIt config
#
# Fingers move strangely
#   → mimic joints accidentally listed
#
############################################################



############################################################
# MAINTENANCE NOTES
############################################################
#
# If URDF changes:
#   revalidate joint list immediately
#
# If hardware driver changes:
#   confirm exposed interfaces again
#
# If switching control mode:
#   update command_interfaces field
#
# Never tune gains randomly.
# Always test systematically.
#
############################################################
